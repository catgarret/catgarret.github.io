<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Font Access — Bootstrap 기본 테마 + 검색</title>

  <!-- ✅ Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 mb-0">Local Font Access — Bootstrap 기본 스타일</h1>
      <button id="btnLoad" class="btn btn-primary">Get local fonts</button>
    </div>

    <div id="alertHost"></div>

    <div class="row g-3">
      <!-- 왼쪽 패널 -->
      <div class="col-lg-5">
        <div class="card p-3">
          <div class="mb-3">
            <label class="form-label">폰트 검색</label>
            <div class="input-group">
              <input id="q" type="search" class="form-control" placeholder="예: 산 / 산돌 / 구름 / Noto ..." />
              <button id="btnClear" class="btn btn-outline-secondary">지우기</button>
            </div>
            <div class="form-text">입력한 글자가 포함된 패밀리를 필터링합니다.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">폰트 패밀리 <span class="text-muted" id="famCount"></span></label>
            <select id="family" size="12" class="form-select"></select>
          </div>

          <div class="mb-3">
            <label class="form-label">변형(Variant)</label>
            <select id="variant" size="6" class="form-select"></select>
          </div>

          <div class="mb-3">
            <label class="form-label">PostScript Name</label>
            <input id="psName" class="form-control" type="text" readonly />
          </div>
        </div>
      </div>

      <!-- 오른쪽 패널 -->
      <div class="col-lg-7">
        <div class="card p-3">
          <div class="mb-3">
            <label class="form-label">샘플 텍스트</label>
            <textarea id="sample" class="form-control" rows="3">다람쥐 헌 쳇바퀴에 타고파 — The quick brown fox jumps over the lazy dog</textarea>
          </div>

          <div class="row g-2 align-items-center mb-3">
            <div class="col-auto">
              <label class="col-form-label">글자 크기</label>
            </div>
            <div class="col">
              <input id="size" type="range" class="form-range" min="10" max="96" step="1" value="28">
            </div>
            <div class="col-auto">
              <input id="sizePx" type="number" class="form-control" style="width:90px" value="28" min="10" max="96" />
            </div>
            <div class="col-auto">
              <button id="btnApply" class="btn btn-outline-primary">적용</button>
            </div>
          </div>

          <div id="preview" class="border rounded p-3" style="font-size:28px; line-height:1.5;">
            샘플 미리보기
          </div>
        </div>
      </div>
    </div>

    <p class="mt-3 text-muted small">
      HTTPS 또는 http://localhost 환경에서 실행해야 합니다. Chrome/Edge 103+ 이상 권장.
    </p>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>

  <script>
    // ===== Local Font Access — Bootstrap 기본 테마 + 검색 =====
    const $ = (s) => document.querySelector(s);

    const $btnLoad = $('#btnLoad');
    const $alertHost = $('#alertHost');
    const $q = $('#q');
    const $btnClear = $('#btnClear');
    const $family = $('#family');
    const $famCount = $('#famCount');
    const $variant = $('#variant');
    const $psName = $('#psName');
    const $sample = $('#sample');
    const $size = $('#size');
    const $sizePx = $('#sizePx');
    const $btnApply = $('#btnApply');
    const $preview = $('#preview');

    let fontsByFamily = new Map();
    let allFamilies = [];
    let filteredFamilies = [];
    let currentFamily = null;

    function showAlert(msg, type='warning') {
      $alertHost.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${msg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }

    function supportsLocalFonts() {
      return typeof window.queryLocalFonts === 'function' ||
        (navigator.fonts && typeof navigator.fonts.queryLocalFonts === 'function');
    }
    function getQueryLocalFonts() {
      if (typeof window.queryLocalFonts === 'function') return window.queryLocalFonts.bind(window);
      if (navigator.fonts && typeof navigator.fonts.queryLocalFonts === 'function') return navigator.fonts.queryLocalFonts.bind(navigator.fonts);
      return null;
    }
    function ensureSecureContext() { return window.isSecureContext === true; }

    function renderFamilyList(list) {
      $family.innerHTML = '';
      for (const fam of list) {
        const opt = document.createElement('option');
        opt.value = fam;
        opt.textContent = fam;
        $family.appendChild(opt);
      }
      $famCount.textContent = list.length ? `(${list.length}개)` : '(0개)';
    }

    function renderVariants(fam) {
      $variant.innerHTML = '';
      const arr = fontsByFamily.get(fam) || [];
      arr.sort((a,b) => (a.style||'').localeCompare(b.style||'') || (a.fullName||'').localeCompare(b.fullName||''));
      for (const f of arr) {
        const opt = document.createElement('option');
        opt.value = f.postscriptName || '';
        opt.textContent = f.fullName || f.style || 'Regular';
        opt.dataset.family = f.family || fam;
        $variant.appendChild(opt);
      }
      if (arr[0]) {
        $variant.selectedIndex = 0;
        $psName.value = arr[0].postscriptName || '';
        setPreview(arr[0]);
      } else {
        $psName.value = '';
        setPreview(null);
      }
    }

    function setPreview(fontMeta) {
      const size = parseInt($sizePx.value || '28', 10);
      $preview.style.fontFamily = `'${fontMeta?.family || currentFamily || 'system-ui'}', system-ui, sans-serif`;
      $preview.style.fontSize = size + 'px';
      $preview.textContent = $sample.value || '';
    }

    function onFamilyChange() {
      const fam = $family.value;
      currentFamily = fam;
      renderVariants(fam);
    }

    function onVariantChange() {
      const idx = $variant.selectedIndex;
      if (idx < 0) return;
      const fam = currentFamily;
      const arr = fontsByFamily.get(fam) || [];
      const chosen = arr[idx];
      $psName.value = chosen?.postscriptName || '';
      setPreview(chosen);
    }

    function applySize() {
      const v = parseInt($size.value, 10);
      $sizePx.value = v;
      const fam = currentFamily;
      const arr = fam ? (fontsByFamily.get(fam) || []) : [];
      const chosen = arr[$variant.selectedIndex] || null;
      setPreview(chosen);
    }

    function syncSizeFromNumber() {
      let v = parseInt($sizePx.value, 10);
      if (isNaN(v)) v = 28;
      v = Math.max(10, Math.min(96, v));
      $sizePx.value = v;
      $size.value = v;
      applySize();
    }

    function normalize(str) { return (str || '').toLowerCase(); }
    function filterFamilies(keyword) {
      const q = normalize(keyword);
      if (!q) return [...allFamilies];
      return allFamilies.filter(fam => normalize(fam).includes(q));
    }

    async function loadFonts() {
      try {
        $btnLoad.disabled = true;
        $alertHost.innerHTML = '';

        if (!ensureSecureContext()) {
          showAlert('HTTPS 또는 http://localhost 에서 실행해야 합니다.', 'danger');
          return;
        }
        if (!supportsLocalFonts()) {
          showAlert('이 브라우저는 Local Font Access API를 지원하지 않습니다.', 'danger');
          return;
        }

        const query = getQueryLocalFonts();
        const fonts = await query();
        if (!Array.isArray(fonts)) {
          showAlert('queryLocalFonts() 반환값이 잘못되었습니다.', 'danger');
          return;
        }

        fontsByFamily = new Map();
        for (const f of fonts) {
          if (!f?.family) continue;
          if (!fontsByFamily.has(f.family)) fontsByFamily.set(f.family, []);
          fontsByFamily.get(f.family).push(f);
        }

        allFamilies = [...fontsByFamily.keys()].sort((a,b)=>a.localeCompare(b));
        filteredFamilies = [...allFamilies];
        renderFamilyList(filteredFamilies);

        if (filteredFamilies.length) {
          $family.selectedIndex = 0;
          onFamilyChange();
        }
      } catch (err) {
        console.error(err);
        showAlert(`폰트를 불러오지 못했습니다.<br><small>${err?.name || ''} ${err?.message || ''}</small>`, 'danger');
      } finally {
        $btnLoad.disabled = false;
      }
    }

    function debounce(fn, ms) { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

    $btnLoad.addEventListener('click', loadFonts);
    $family.addEventListener('change', onFamilyChange);
    $variant.addEventListener('change', onVariantChange);
    $size.addEventListener('input', applySize);
    $sizePx.addEventListener('change', syncSizeFromNumber);
    $btnApply.addEventListener('click', syncSizeFromNumber);

    $q.addEventListener('input', debounce(() => {
      filteredFamilies = filterFamilies($q.value);
      renderFamilyList(filteredFamilies);
      if (filteredFamilies.length) {
        $family.selectedIndex = 0;
        onFamilyChange();
      } else {
        $variant.innerHTML = '';
        $psName.value = '';
        setPreview(null);
      }
    }, 120));

    $btnClear.addEventListener('click', () => {
      $q.value = '';
      filteredFamilies = [...allFamilies];
      renderFamilyList(filteredFamilies);
      if (filteredFamilies.length) {
        $family.selectedIndex = 0;
        onFamilyChange();
      }
    });

    syncSizeFromNumber();
  </script>
</body>
</html>
